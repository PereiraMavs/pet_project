<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Auction Central ‚Äî Live Sports Player Auction</title>
  <meta name="description" content="Run a live player auction with four teams. Track budgets, bids, rosters, and show player cards with photo and availability." />
  <meta property="og:title" content="Auction Central ‚Äî Live Sports Player Auction" />
  <meta property="og:description" content="Run a live player auction with four teams. Track budgets, bids, rosters, and show player cards with photo and availability." />
  <meta property="og:type" content="website" />
  <meta name="theme-color" content="#10b981" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üèüÔ∏è</text></svg>"> 
  <style>
    :root{
      /* Light, clean palette */
      --bg: #ffffff;
      --surface: #f7fafc; /* light card */
      --muted: #4a5568; /* slate-700 */
      --text: #0f172a; /* slate-900 */
      --border: #e2e8f0; /* slate-200 */

      --accent: #10b981; /* emerald-500 */
      --accent-600: #059669;
      --accent-faint: rgba(16,185,129,.15);

      --ring: rgba(16,185,129,.35);
      --shadow: 0 10px 30px rgba(2,8,23,.08);
    }
    *{ box-sizing: border-box }
    html{ scroll-behavior: smooth }
    body{
      margin:0; font: 16px/1.6 system-ui, -apple-system, Segoe UI, Inter, Roboto, Arial, sans-serif;
      color: var(--text); background: var(--bg);
      background-image: radial-gradient(800px 400px at 110% -20%, rgba(16,185,129,.08), transparent), radial-gradient(700px 300px at 0% -10%, rgba(59,130,246,.08), transparent);
    }
    a{ color: inherit; text-decoration: none }
    .container{ max-width: 1220px; margin-inline:auto; padding: 1.2rem }
    .btn{ display:inline-flex; align-items:center; gap:.5rem; padding:.8rem 1.1rem; border-radius:14px; background:var(--accent); color:#fff; font-weight:700; box-shadow: var(--shadow); border:1px solid transparent; transition:.18s; cursor:pointer }
    .btn:hover{ transform: translateY(-1px); background: var(--accent-600) }
    .btn.ghost{ background:transparent; color: var(--text); border-color: var(--border); box-shadow:none }
    .btn.small{ padding:.5rem .7rem; border-radius:10px; font-weight:700 }

    header{ position: sticky; top:0; z-index:50; backdrop-filter: blur(10px); background: color-mix(in srgb, var(--bg) 70%, transparent); border-bottom:1px solid var(--border) }
    .nav{ display:flex; align-items:center; justify-content:space-between; gap:1rem }
    .brand{ display:flex; align-items:center; gap:.6rem; font-weight:900; letter-spacing:.2px }
    .brand .logo{ width:38px; height:38px; border-radius:10px; display:grid; place-items:center; background:linear-gradient(135deg,var(--accent),#3b82f6); color:white; box-shadow: var(--shadow) }
    .links{ display:flex; gap:1rem; align-items:center }
    .links a{ padding:.5rem .7rem; border-radius:10px; color:var(--muted) }
    .links a:hover{ background: color-mix(in srgb, #000 5%, transparent) }
    .menu-btn{ display:none; background:none; border:0; color:var(--text); font:inherit; padding:.5rem; border-radius:10px }
    .menu-btn:focus-visible{ outline:3px solid var(--ring) }
    @media (max-width: 820px){
      .links{ display:none }
      .menu-btn{ display:block }
      .mobile{ display:none; position:absolute; top:64px; left:0; right:0; padding: .8rem 1.2rem 1.2rem; background: color-mix(in srgb, var(--bg) 90%, transparent); border-bottom:1px solid var(--border) }
      .mobile a{ display:block; padding:.8rem; border-radius:12px; color:var(--muted) }
      .mobile a:hover{ background: color-mix(in srgb, #000 5%, transparent) }
    }

    .hero{ display:grid; grid-template-columns: 1.2fr 1fr; gap: 2rem; align-items:center; padding-block: min(10vh, 5rem) }
    .title{ font-size: clamp(2rem, 3vw + 1rem, 3.2rem); line-height: 1.15; margin: 0 0 .6rem }
    .subtitle{ color: var(--muted); margin:0 0 1.1rem }
    .card{ background: var(--surface); border:1px solid var(--border); border-radius:20px; padding:1.2rem; box-shadow: var(--shadow) }
    .card img{ width:100%; border-radius:14px; aspect-ratio: 16/9; object-fit: cover }

    @media (max-width: 920px){ .hero{ grid-template-columns: 1fr } }

    .section{ padding-block: 3.2rem }
    .section h2{ font-size: clamp(1.4rem, 1.2vw + 1rem, 2rem); margin:0 0 .4rem }
    .section p.lead{ color:var(--muted); margin:0 0 1.2rem }

    .grid{ display:grid; gap:1rem }
    .grid.cols-2{ grid-template-columns: 1fr 1fr }
    .grid.cols-3{ grid-template-columns: 1fr 1fr 1fr }
    .grid.cols-4{ grid-template-columns: repeat(4, 1fr) }
    @media (max-width: 1000px){ .grid.cols-4{ grid-template-columns: repeat(2, 1fr) } }
    @media (max-width: 640px){ .grid.cols-2, .grid.cols-3{ grid-template-columns: 1fr } }

    .feature{ background: var(--surface); border:1px solid var(--border); border-radius:18px; padding:1rem }
    .feature h3{ margin:.2rem 0 .4rem; font-size:1.05rem }
    .feature p{ color: var(--muted); margin:0 }

    form{ display:grid; gap:.8rem }
    label{ font-weight:700 }
    input, select, textarea{ width:100%; padding:.9rem 1rem; border-radius:12px; border:1px solid var(--border); background:#fff; color: var(--text) }
    input:focus, select:focus, textarea:focus{ outline: 3px solid var(--ring); border-color: transparent }
    textarea{ min-height: 120px; resize: vertical }

    table{ width:100%; border-collapse: collapse; font-size:.95rem }
    th, td{ padding:.6rem .5rem; border-bottom:1px solid var(--border) }
    th{ text-align:left; color: var(--muted); font-weight:700 }
    tbody tr:hover{ background: #f9fafb }

    .muted{ color: var(--muted) }
    .center{ text-align:center }
    .right{ text-align:right }
    .pill{ display:inline-block; padding:.25rem .55rem; border-radius:999px; background: var(--accent-faint); color: var(--accent); font-weight:700; font-size:.8rem }
    .warn{ color:#b45309 }

    .score{ font-size: 2rem; font-weight: 800 }

    .toast{ position: fixed; right: 1rem; bottom: 1rem; background:#111827; color:#fff; padding:.8rem 1rem; border-radius:12px; box-shadow: var(--shadow); opacity:0; transform: translateY(10px); transition:.2s }
    .toast.show{ opacity:1; transform: translateY(0) }

    footer{ padding: 2rem 0; color: var(--muted) }
  </style>
</head>
<body>
  <header>
    <div class="container nav" role="navigation" aria-label="Primary">
      <a class="brand" href="#top" aria-label="Go to top">
        <span class="logo" aria-hidden="true">‚öΩ</span>
        <span>Auction Central</span>
      </a>
      <nav class="links" aria-label="Site">
        <a href="#setup">Setup</a>
        <a href="#auction">Auction</a>
        <a href="#rosters">Rosters</a>
        <a href="#pool">Player Pool</a>
        <a href="#log">Log</a>
        <a class="btn" href="#auction">Run Auction</a>
      </nav>
      <button class="menu-btn" aria-expanded="false" aria-controls="mobile-menu" id="menuBtn" title="Open menu">‚ò∞</button>
    </div>
    <div id="mobile-menu" class="mobile container" hidden>
      <a href="#setup">Setup</a>
      <a href="#auction">Auction</a>
      <a href="#rosters">Rosters</a>
      <a href="#pool">Player Pool</a>
      <a href="#log">Log</a>
    </div>
  </header>

  <main id="top">
    <section class="container hero">
      <div>
        <h1 class="title">Live player auction for four teams</h1>
        <p class="subtitle">Track budgets, show player cards, pick players randomly, and record winning bids with a click. Designed for an in-person event with managers present.</p>
        <div style="display:flex; gap:.6rem; flex-wrap:wrap">
          <a class="btn" href="#setup">Set up rules & teams</a>
          <a class="btn ghost" href="#auction">Go to auction</a>
        </div>
      </div>
      <div class="card">
        <img src="https://images.unsplash.com/photo-1517747614396-d21a78b850e8?q=80&w=1400&auto=format&fit=crop" alt="Stadium lights over a sports field at dusk" />
      </div>
    </section>

    <section id="setup" class="section container">
      <h2>Setup</h2>
      <p class="lead">Rules and initial data. This auction mode enforces exactly four teams.</p>
      <div class="grid cols-2">
        <div class="feature">
          <h3>Rules</h3>
          <form id="rulesForm" aria-label="Auction rules">
            <div class="grid cols-2">
              <div>
                <label for="startBudget">Starting budget per team</label>
                <input id="startBudget" type="number" min="1" step="1" value="200" required />
              </div>
              <div>
                <label for="minPlayers">Minimum players per team</label>
                <input id="minPlayers" type="number" min="1" step="1" value="18" required />
              </div>
            </div>
            <div class="grid cols-2">
              <div>
                <label for="minBid">Minimum starting bid</label>
                <input id="minBid" type="number" min="1" step="1" value="5" required />
              </div>
              <div>
                <label for="increment">Bid increment</label>
                <input id="increment" type="number" min="1" step="1" value="1" required />
              </div>
            </div>
            <div class="grid cols-2">
              <div>
                <label><input id="lockAfterDraw" type="checkbox" checked /> Lock rules after first draw</label>
              </div>
              <div style="text-align:right">
                <button class="btn ghost" type="button" id="lockNowBtn">üîí Lock now</button>
                <label class="pill" id="lockStatus" style="margin-left:.4rem">Unlocked</label>
              </div>
            </div>
            <div class="grid cols-2">
              <div>
                <label><input id="adminOverride" type="checkbox" /> Admin override: unlock rules</label>
              </div>
              <div class="right">
                <button class="btn" type="submit" id="saveRulesBtn">Save rules</button>
                <button class="btn ghost" type="button" id="applyBudgetAll">Apply new budget to all teams</button>
              </div>
            </div>
            <p class="muted" id="rulesInfo"></p>
          </form>
        </div>

        <div class="feature">
          <h3>Teams (4)</h3>
          <form id="teamForm" aria-label="Add team">
            <div class="grid cols-2">
              <div>
                <label for="teamName">Team name</label>
                <input id="teamName" required placeholder="Tigers" />
              </div>
              <div>
                <label for="managerName">Manager</label>
                <input id="managerName" required placeholder="Alex" />
              </div>
            </div>
            <div>
              <button class="btn" type="submit" id="addTeamBtn">Add team</button>
              <button class="btn ghost" type="button" id="clearTeams">Clear teams</button>
            </div>
          </form>
          <div style="margin-top:1rem; overflow:auto">
            <table aria-label="Teams table">
              <thead>
                <tr><th>#</th><th>Team</th><th>Manager</th><th>Budget</th><th>Players</th><th class="right">Actions</th></tr>
              </thead>
              <tbody id="teamTable"></tbody>
            </table>
            <p class="muted" id="teamCountInfo"></p>
          </div>
        </div>
      </div>

      <div class="feature" style="margin-top:1rem">
        <h3>Players</h3>
        <form id="playerForm" aria-label="Add player">
          <div class="grid cols-4">
            <div>
              <label for="playerName">Player name</label>
              <input id="playerName" required placeholder="Sam Lee" />
            </div>
            <div>
              <label for="playerPos">Position</label>
              <input id="playerPos" placeholder="FWD" />
            </div>
            <div>
              <label for="playerDates">Dates available</label>
              <input id="playerDates" placeholder="Aug 20‚Äì22; Aug 29" />
            </div>
            <div>
              <label for="playerPhoto">Photo URL</label>
              <input id="playerPhoto" placeholder="https://..." />
            </div>
          </div>
          <div>
            <button class="btn" type="submit">Add player</button>
            <button class="btn ghost" type="button" id="clearPlayers">Clear players</button>
          </div>
        </form>
        <div style="margin-top:1rem; overflow:auto">
          <table aria-label="Players table">
            <thead>
              <tr><th>#</th><th>Player</th><th>Pos</th><th>Dates</th><th>Photo</th><th class="right">Actions</th></tr>
            </thead>
            <tbody id="playerTable"></tbody>
          </table>
          <p class="muted" id="poolCount"></p>
        </div>
      </div>
    </section>

    <section id="auction" class="section container">
      <h2>Auction</h2>
      <p class="lead">Pick a random player, then let managers bid live. The site prevents overbids and shows each team‚Äôs max next bid based on remaining budget and the minimum roster rule.</p>

      <div class="grid cols-2">
        <div class="feature">
          <h3>Now auctioning</h3>
          <div id="nowCard" class="card" style="margin-bottom: .8rem;">
            <img id="nowPhoto" src="" alt="Player photo" />
            <div style="padding:.8rem 0">
              <div style="display:flex; align-items:center; justify-content:space-between; gap:.6rem">
                <strong id="nowName">‚Äî</strong>
                <span class="pill" id="nowPos">‚Äî</span>
              </div>
              <p class="muted" id="nowDates" style="margin:.2rem 0 0">‚Äî</p>
            </div>
          </div>

          <div class="feature">
            <div style="display:flex; align-items:center; justify-content:space-between">
              <div>Current highest bid</div>
              <div class="score" id="highestBid">0</div>
            </div>
            <p class="muted" id="highestTeam">No bids yet</p>
            <div style="display:flex; gap:.6rem; flex-wrap:wrap; margin-top:.6rem">
              <button class="btn" id="drawBtn">üéüÔ∏è Draw random player</button>
              <button class="btn ghost" id="unsoldBtn">Mark unsold</button>
              <button class="btn ghost" id="cancelAuctionBtn">Cancel auction</button>
              <button class="btn" id="finalizeBtn">‚úÖ Finalize sale</button>
            </div>
            <p class="muted" id="auctionHint"></p>
          </div>
        </div>

        <div class="feature">
          <h3>Bid controls</h3>
          <div id="bidGrid" class="grid cols-2"></div>
        </div>
      </div>

      <div class="feature" style="margin-top:1rem">
        <h3>Team budgets & max next bid</h3>
        <div style="overflow:auto">
          <table>
            <thead><tr><th>Team</th><th>Manager</th><th>Bought</th><th>Remaining</th><th>Needed to min</th><th>Max next bid</th></tr></thead>
            <tbody id="budgetTable"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="rosters" class="section container">
      <h2>Rosters</h2>
      <div id="rosterGrid" class="grid cols-4"></div>
    </section>

    <section id="pool" class="section container">
      <h2>Player pool</h2>
      <div class="feature">
        <table>
          <thead><tr><th>#</th><th>Player</th><th>Pos</th><th>Dates</th></tr></thead>
          <tbody id="poolTable"></tbody>
        </table>
      </div>
    </section>

    <section id="log" class="section container">
      <h2>Activity log</h2>
      <div class="feature" style="max-height: 360px; overflow:auto">
        <ol id="logList"></ol>
      </div>
      <div style="margin-top:.6rem; display:flex; gap:.6rem; flex-wrap:wrap">
        <button class="btn ghost" id="exportBtn">‚¨áÔ∏è Export JSON</button>
        <button class="btn ghost" id="resetBtn">üóëÔ∏è Reset all</button>
      </div>
    </section>
  </main>

  <footer>
    <div class="container center">
      <small>¬© <span id="year"></span> Your League. Replace the ‚öΩ when your logo is ready.</small>
    </div>
  </footer>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script>
    // ---------------- State ----------------
    const state = {
      settings: { startBudget: 200, minPlayers: 18, minBid: 5, increment: 1, lockAfterDraw: true },
      teams: [], // {id, name, manager, budget}
      players: [], // {id, name, pos, dates, photo}
      rosters: {}, // teamId -> [{playerId, price}]
      auction: { active: false, playerId: null, highestBid: 0, highestTeamId: null, history: [] },
      log: [],
      lastAction: null,
      locked: false,          // rules locked due to draw or manual lock
      adminOverride: false    // allows temporary edits when locked
    };

    const el = (id) => document.getElementById(id);
    const randId = () => Math.random().toString(36).slice(2,9);
    const save = () => localStorage.setItem('auctionCentralV1', JSON.stringify(state));
    const load = () => {
      const raw = localStorage.getItem('auctionCentralV1'); if(!raw) return;
      try{ const data = JSON.parse(raw); Object.assign(state, data); }
      catch(e){ console.error('Load failed', e); }
    };
    const toast = (msg) => { const t = el('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(()=> t.classList.remove('show'), 1800); };

    // --------------- Helpers ----------------
    const ts = () => new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    const esc = (s='') => String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));

    function teamById(id){ return state.teams.find(t=>t.id===id); }
    function rosterFor(id){ return state.rosters[id] || (state.rosters[id]=[]); }
    function spentFor(id){ return rosterFor(id).reduce((s,r)=> s + (r?.price||0), 0); }
    function remainingFor(id){ const t = teamById(id); return Math.max(0, (t?.budget||0) - spentFor(id)); }
    function boughtCount(id){ return rosterFor(id).length; }

    function maxNextBidFor(id){
      const remaining = remainingFor(id);
      const bought = boughtCount(id);
      const needed = Math.max(0, state.settings.minPlayers - bought);
      if(needed <= 1) return remaining; // either already met, or can spend all on this one
      // Must save minBid for (needed-1) future players
      return Math.max(0, remaining - (needed - 1) * state.settings.minBid);
    }

    function canStartAuction(){ return state.teams.length === 4 && state.players.length > 0; }

    function currentPlayer(){ return state.players.find(p=>p.id===state.auction.playerId); }

    function isLocked(){ return state.locked && !state.adminOverride; }

    // --------------- Teams ----------------
    function addTeam(name, manager){
      if(isLocked()){ toast('Rules are locked'); return; }
      if(state.teams.length >= 4){ toast('Exactly four teams allowed'); return; }
      name = name.trim(); manager = (manager||'').trim(); if(!name||!manager) return;
      const t = { id: randId(), name, manager, budget: state.settings.startBudget };
      state.teams.push(t); state.rosters[t.id] = state.rosters[t.id]||[];
      state.lastAction = { type:'add-team', payload:t }; save(); render();
    }
    function removeTeam(id){
      if(isLocked()){ toast('Rules are locked'); return; }
      if(state.teams.length <= 0) return;
      if(!confirm('Remove team? Any bought players will be returned to pool.')) return;
      // return players (best-effort)
      const roster = rosterFor(id).slice();
      roster.forEach(item=>{
        // We don't delete sold players from state.players; they were removed on sale. This is a visual fallback only
        if(item && item._playerBackup) state.players.push(item._playerBackup);
      });
      state.rosters[id] = [];
      state.teams = state.teams.filter(t=>t.id!==id);
      save(); render();
    }

    // --------------- Players ----------------
    function addPlayer(name, pos, dates, photo){
      name = name.trim(); if(!name) return;
      const p = { id: randId(), name, pos: (pos||'').trim(), dates: (dates||'').trim(), photo: (photo||'').trim() };
      state.players.push(p); state.lastAction = { type:'add-player', payload:p }; save(); render();
    }
    function removePlayer(id){
      const isActive = state.auction.active && state.auction.playerId === id;
      if(isActive){ toast('Cannot remove player during active auction'); return; }
      const p = state.players.find(x=>x.id===id);
      state.players = state.players.filter(x=>x.id!==id);
      state.lastAction = { type:'remove-player', payload:p }; save(); render();
    }

    // --------------- Auction ----------------
    function drawPlayer(){
      if(!canStartAuction()){ toast('Need 4 teams and at least 1 player'); return; }
      if(state.auction.active){ toast('Auction already active ‚Äî finalize or cancel first'); return; }
      const idx = Math.floor(Math.random()*state.players.length);
      const p = state.players[idx];
      state.auction = { active:true, playerId: p.id, highestBid: 0, highestTeamId: null, history: [] };
      if(state.settings.lockAfterDraw) state.locked = true; // lock rules after first draw
      renderAuction();
      renderRules();
      renderTeams();
      toast(`Auctioning: ${p.name}`);
    }

    function cancelAuction(){
      if(!state.auction.active){ toast('No active auction'); return; }
      state.auction = { active:false, playerId:null, highestBid:0, highestTeamId:null, history:[] };
      render();
    }

    function markUnsold(){
      if(!state.auction.active){ toast('No active auction'); return; }
      const p = currentPlayer();
      state.log.unshift(`${ts()} Unsold: ${p?.name||'Player'}`);
      cancelAuction();
    }

    function placeBid(teamId, amount){
      const inc = state.settings.increment;
      amount = Math.floor(amount);
      const minAllowed = Math.max(state.settings.minBid, state.auction.highestBid + inc);
      if(!state.auction.active){ toast('Draw a player first'); return; }
      if(teamId === state.auction.highestTeamId){ toast('Already highest'); return; }
      if(amount < minAllowed){ toast(`Bid must be ‚â• ${minAllowed}`); return; }
      const maxAllowed = Math.floor(maxNextBidFor(teamId));
      if(amount > maxAllowed){ toast('Over max next bid for this team'); return; }
      // accept bid
      state.auction.highestBid = amount;
      state.auction.highestTeamId = teamId;
      state.auction.history.unshift({ teamId, amount, time: Date.now() });
      renderAuction();
    }

    function raiseBid(teamId, by){
      const base = Math.max(state.auction.highestBid, state.settings.minBid - state.settings.increment);
      placeBid(teamId, base + by);
    }

    function finalizeSale(){
      if(!state.auction.active){ toast('No active auction'); return; }
      const p = currentPlayer();
      if(!state.auction.highestTeamId){ toast('No bids yet'); return; }
      const teamId = state.auction.highestTeamId;
      const price = state.auction.highestBid;
      // Remove player from pool
      state.players = state.players.filter(x=>x.id !== p.id);
      // Add to roster with price
      rosterFor(teamId).push({ playerId: p.id, price, _playerBackup: p });
      state.log.unshift(`${ts()} SOLD: ${p.name} to ${teamById(teamId).name} for ${price}`);
      // Clear auction
      state.auction = { active:false, playerId:null, highestBid:0, highestTeamId:null, history:[] };
      save(); render();
    }

    // --------------- Export / Reset ----------------
    function exportJSON(){
      const payload = buildSnapshot();
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `auction_${Date.now()}.json`; a.click();
      URL.revokeObjectURL(url);
    }
    function resetAll(){
      if(!confirm('Reset EVERYTHING? Teams, players, rosters, and log will be cleared.')) return;
      state.settings = { startBudget: 200, minPlayers: 18, minBid: 5, increment: 1, lockAfterDraw: true };
      state.teams = []; state.players = []; state.rosters = {}; state.log = []; state.auction = {active:false, playerId:null, highestBid:0, highestTeamId:null, history:[]};
      state.locked = false; state.adminOverride = false;
      save(); render();
    }

    function buildSnapshot(){
      const rosterObj = Object.fromEntries(Object.entries(state.rosters).map(([tid, items])=>[
        tid,
        items.map(it=>({
          player: it._playerBackup || { id: it.playerId, name: '(sold)' },
          price: it.price
        }))
      ]));
      return {
        generatedAt: new Date().toISOString(),
        settings: state.settings,
        locked: state.locked,
        teams: state.teams.map(t=>({ ...t, spent: spentFor(t.id), remaining: remainingFor(t.id), bought: boughtCount(t.id) })),
        rosters: rosterObj,
        pool: state.players,
        log: state.log
      };
    }

    // --------------- Render ----------------
    function render(){
      renderRules();
      renderTeams();
      renderPlayers();
      renderAuction();
      renderBudgets();
      renderRosters();
      renderPoolTable();
      renderLog();
      document.getElementById('year').textContent = new Date().getFullYear();
      save();
    }

    function setDisabled(id, disabled){ const x = el(id); if(x) x.disabled = !!disabled; }

    function renderRules(){
      el('startBudget').value = state.settings.startBudget;
      el('minPlayers').value = state.settings.minPlayers;
      el('minBid').value = state.settings.minBid;
      el('increment').value = state.settings.increment;
      el('lockAfterDraw').checked = !!state.settings.lockAfterDraw;

      const lockedNow = isLocked();
      el('lockStatus').textContent = lockedNow ? 'Locked' : 'Unlocked';

      setDisabled('startBudget', lockedNow);
      setDisabled('minPlayers', lockedNow);
      setDisabled('minBid', lockedNow);
      setDisabled('increment', lockedNow);
      setDisabled('applyBudgetAll', lockedNow);
      setDisabled('saveRulesBtn', lockedNow);
      setDisabled('lockAfterDraw', lockedNow);
      setDisabled('lockNowBtn', lockedNow);

      // Admin override checkbox mirrors state
      el('adminOverride').checked = !!state.adminOverride;
      if(state.locked && state.adminOverride){
        el('lockStatus').textContent = 'Locked (Admin override active)';
      }

      el('rulesInfo').textContent = `Start budget ${state.settings.startBudget} ‚Ä¢ Min players ${state.settings.minPlayers} ‚Ä¢ Min bid ${state.settings.minBid} ‚Ä¢ Increment ${state.settings.increment} ‚Ä¢ Lock after draw: ${state.settings.lockAfterDraw ? 'On' : 'Off'}`;

      // Disable team form inputs/buttons when locked
      setDisabled('teamName', lockedNow);
      setDisabled('managerName', lockedNow);
      setDisabled('addTeamBtn', lockedNow);
      setDisabled('clearTeams', lockedNow);
    }

    function renderTeams(){
      const tb = el('teamTable'); tb.innerHTML='';
      const lockedNow = isLocked();
      state.teams.forEach((t, idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${idx+1}</td>
                        <td>${esc(t.name)}</td>
                        <td>${esc(t.manager)}</td>
                        <td><input type="number" min="0" step="1" value="${t.budget}" style="width:92px" data-team-budget="${t.id}" ${lockedNow?'disabled':''}></td>
                        <td>${boughtCount(t.id)}</td>
                        <td class="right"><button class="btn small ghost" data-remove-team="${t.id}" ${lockedNow?'disabled':''}>Remove</button></td>`;
        tb.appendChild(tr);
      });
      el('teamCountInfo').textContent = `${state.teams.length}/4 teams`;
    }

    function renderPlayers(){
      const pb = el('playerTable'); pb.innerHTML='';
      state.players.forEach((p,i)=>{
        const tr = document.createElement('tr');
        const thumb = esc(p.photo||'');
        tr.innerHTML = `<td>${i+1}</td>
                        <td>${esc(p.name)}</td>
                        <td>${esc(p.pos||'')}</td>
                        <td>${esc(p.dates||'')}</td>
                        <td>${thumb? `<a href="${thumb}" target="_blank" rel="noopener">Link</a>` : '<span class="muted">‚Äî</span>'}</td>
                        <td class="right"><button class="btn small ghost" data-remove-player="${p.id}">Remove</button></td>`;
        pb.appendChild(tr);
      });
      el('poolCount').textContent = `${state.players.length} player(s) in pool`;
    }

    function renderAuction(){
      const a = state.auction;
      // Now card
      const p = currentPlayer();
      el('nowName').textContent = p? p.name : '‚Äî';
      el('nowPos').textContent = p?.pos || '‚Äî';
      el('nowDates').textContent = p?.dates || '‚Äî';
      el('nowPhoto').src = p?.photo || 'https://images.unsplash.com/photo-1521417531039-96c46b79a9f3?q=80&w=1200&auto=format&fit=crop';
      el('highestBid').textContent = a.highestBid || 0;
      el('highestTeam').textContent = a.highestTeamId ? `Highest: ${teamById(a.highestTeamId)?.name||''}` : 'No bids yet';
      el('auctionHint').textContent = state.teams.length===4 ? (isLocked()? 'Rules locked' : '') : 'Add exactly 4 teams to enable bidding';

      // Bid grid (two columns)
      const bg = el('bidGrid'); bg.innerHTML='';
      state.teams.forEach(t=>{
        const remaining = remainingFor(t.id);
        const maxNext = Math.floor(maxNextBidFor(t.id));
        const bought = boughtCount(t.id);
        const needed = Math.max(0, state.settings.minPlayers - bought);
        const canBid = a.active && remaining > 0 && maxNext > a.highestBid;
        const card = document.createElement('div'); card.className='feature';
        card.innerHTML = `<div style="display:flex; align-items:center; justify-content:space-between; gap:.6rem">
                            <h3 style="margin:0">${esc(t.name)}</h3>
                            <span class="pill">Mgr: ${esc(t.manager)}</span>
                          </div>
                          <p class="muted" style="margin:.3rem 0 .6rem">Remaining: <strong>${remaining}</strong> ‚Ä¢ Bought: <strong>${bought}</strong> ‚Ä¢ Needed: <strong>${needed}</strong></p>
                          <p class="muted" style="margin:.2rem 0 .6rem">Max next bid to still make min: <strong>${maxNext}</strong></p>
                          <div style="display:flex; gap:.5rem; flex-wrap:wrap">
                            <button class="btn small" data-bid-inc="1" data-team="${t.id}" ${!canBid?'disabled':''}>+1</button>
                            <button class="btn small" data-bid-inc="5" data-team="${t.id}" ${!canBid?'disabled':''}>+5</button>
                            <button class="btn small" data-bid-inc="10" data-team="${t.id}" ${!canBid?'disabled':''}>+10</button>
                            <input data-bid-exact-input="${t.id}" type="number" min="${state.settings.minBid}" step="1" placeholder="Custom" style="width:110px" ${!a.active?'disabled':''} />
                            <button class="btn small ghost" data-bid-exact="${t.id}" ${!a.active?'disabled':''}>Bid exact</button>
                          </div>`;
        bg.appendChild(card);
      });
    }

    function renderBudgets(){
      const bt = el('budgetTable'); bt.innerHTML='';
      state.teams.forEach(t=>{
        const bought = boughtCount(t.id);
        const remaining = remainingFor(t.id);
        const needed = Math.max(0, state.settings.minPlayers - bought);
        const maxNext = Math.floor(maxNextBidFor(t.id));
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${esc(t.name)}</td><td>${esc(t.manager)}</td><td>${bought}</td><td>${remaining}</td><td>${needed}</td><td>${maxNext}</td>`;
        bt.appendChild(tr);
      });
    }

    function renderRosters(){
      const rg = el('rosterGrid'); rg.innerHTML='';
      state.teams.forEach(t=>{
        const items = rosterFor(t.id);
        const li = document.createElement('div'); li.className='feature';
        li.innerHTML = `<h3>${esc(t.name)}</h3>
                        <p class="muted" style="margin-top:-.4rem">Spent: ${spentFor(t.id)} ‚Ä¢ Remaining: ${remainingFor(t.id)}</p>
                        <ul style="margin:.6rem 0 0; padding-left:1rem">
                          ${items.map(it=>{
                            const p = it._playerBackup || {name:'(sold)'};
                            return `<li>${esc(p.name)}${p.pos? ' ‚Äî <span class=\"muted\">'+esc(p.pos)+'</span>':''} ‚Ä¢ <strong>${it.price}</strong></li>`;
                          }).join('') || '<li class="muted">No players yet</li>'}
                        </ul>`;
        rg.appendChild(li);
      });
    }

    function renderPoolTable(){
      const pool = el('poolTable'); pool.innerHTML='';
      state.players.forEach((p, i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i+1}</td><td>${esc(p.name)}</td><td>${esc(p.pos||'')}</td><td>${esc(p.dates||'')}</td>`;
        pool.appendChild(tr);
      });
    }

    function renderLog(){
      const log = el('logList'); log.innerHTML = state.log.map(item=>`<li>${item}</li>`).join('');
    }

    // --------------- Events ----------------
    document.addEventListener('input', (e)=>{
      if(e.target.id==='startBudget' || e.target.id==='minPlayers' || e.target.id==='minBid' || e.target.id==='increment'){
        // Just update preview; saving happens on form submit
      }
      if(e.target.hasAttribute('data-team-budget')){
        if(isLocked()){ e.target.value = teamById(e.target.getAttribute('data-team-budget')).budget; return; }
        const id = e.target.getAttribute('data-team-budget');
        const t = teamById(id); if(t){ t.budget = Math.max(0, parseInt(e.target.value,10)||0); render(); }
      }
      if(e.target.id==='lockAfterDraw'){
        state.settings.lockAfterDraw = !!e.target.checked; save();
      }
      if(e.target.id==='adminOverride'){
        state.adminOverride = !!e.target.checked; render();
      }
    });

    document.addEventListener('click', (e)=>{
      const inc = e.target.getAttribute('data-bid-inc');
      if(inc){ const id = e.target.getAttribute('data-team'); raiseBid(id, parseInt(inc,10)||1); return; }

      const exact = e.target.getAttribute('data-bid-exact');
      if(exact){ const input = document.querySelector(`[data-bid-exact-input="${exact}"]`); if(input){ placeBid(exact, parseInt(input.value,10)||0); } return; }

      const rt = e.target.getAttribute('data-remove-team'); if(rt){ removeTeam(rt); return; }
      const rp = e.target.getAttribute('data-remove-player'); if(rp){ removePlayer(rp); return; }

      if(e.target.id==='lockNowBtn'){ state.locked = true; render(); toast('Rules locked'); return; }
    });

    el('rulesForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      if(isLocked()){ toast('Rules are locked'); return; }
      state.settings.startBudget = Math.max(0, parseInt(el('startBudget').value,10)||200);
      state.settings.minPlayers = Math.max(1, parseInt(el('minPlayers').value,10)||18);
      state.settings.minBid = Math.max(1, parseInt(el('minBid').value,10)||5);
      state.settings.increment = Math.max(1, parseInt(el('increment').value,10)||1);
      save(); render(); toast('Rules saved');
    });
    el('applyBudgetAll').addEventListener('click', ()=>{
      if(isLocked()){ toast('Rules are locked'); return; }
      state.teams.forEach(t=> t.budget = state.settings.startBudget);
      save(); render(); toast('Applied new starting budget to all teams');
    });

    el('teamForm').addEventListener('submit', (e)=>{
      e.preventDefault(); addTeam(el('teamName').value, el('managerName').value); if(!isLocked()) { e.target.reset(); toast('Team added'); }
    });
    el('clearTeams').addEventListener('click', ()=>{ if(isLocked()){ toast('Rules are locked'); return; } if(confirm('Remove all teams?')){ state.teams=[]; state.rosters={}; save(); render(); }});

    el('playerForm').addEventListener('submit', (e)=>{
      e.preventDefault(); addPlayer(el('playerName').value, el('playerPos').value, el('playerDates').value, el('playerPhoto').value); e.target.reset(); toast('Player added');
    });
    el('clearPlayers').addEventListener('click', ()=>{ if(confirm('Remove all players?')){ state.players=[]; save(); render(); }});

    el('drawBtn').addEventListener('click', drawPlayer);
    el('cancelAuctionBtn').addEventListener('click', cancelAuction);
    el('unsoldBtn').addEventListener('click', markUnsold);
    el('finalizeBtn').addEventListener('click', finalizeSale);

    el('exportBtn').addEventListener('click', exportJSON);
    el('resetBtn').addEventListener('click', resetAll);

    // Mobile menu toggle
    const btn = document.getElementById('menuBtn');
    const menu = document.getElementById('mobile-menu');
    btn.addEventListener('click', () => {
      const expanded = btn.getAttribute('aria-expanded') === 'true';
      btn.setAttribute('aria-expanded', String(!expanded));
      menu.hidden = expanded;
    });
    menu.addEventListener('click', (e) => { if(e.target.tagName === 'A'){ btn.setAttribute('aria-expanded', 'false'); menu.hidden = true; }});

    // Boot
    load(); render();
  </script>
</body>
</html>
